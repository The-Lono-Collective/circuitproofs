name: Claude Code Triage

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  triage:
    # Only trigger on PRs when @claude is mentioned
    # Handle both issue_comment (PR comments) and pull_request_review_comment (line-level comments)
    if: |
      contains(github.event.comment.body, '@claude') &&
      (
        (github.event_name == 'issue_comment' && github.event.issue.pull_request != null) ||
        github.event_name == 'pull_request_review_comment'
      )
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      issues: write
    outputs:
      tier: ${{ steps.parse.outputs.tier }}
      pr_number: ${{ github.event.issue.number || github.event.pull_request.number }}
      triage_summary: ${{ steps.extract.outputs.summary }}
      files_changed: ${{ steps.extract.outputs.files_changed }}
      has_lean_files: ${{ steps.extract.outputs.has_lean_files }}
      skip_prescreen: ${{ steps.override.outputs.skip_prescreen }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check for manual override
        id: override
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Use grep for safe pattern matching instead of shell expansion
          if echo "$COMMENT_BODY" | grep -qF "@claude --simple"; then
            echo "tier=simple" >> $GITHUB_OUTPUT
            echo "override=true" >> $GITHUB_OUTPUT
            echo "skip_prescreen=false" >> $GITHUB_OUTPUT
          elif echo "$COMMENT_BODY" | grep -qF "@claude --moderate"; then
            echo "tier=moderate" >> $GITHUB_OUTPUT
            echo "override=true" >> $GITHUB_OUTPUT
            echo "skip_prescreen=false" >> $GITHUB_OUTPUT
          elif echo "$COMMENT_BODY" | grep -qF "@claude --complex"; then
            echo "tier=complex" >> $GITHUB_OUTPUT
            echo "override=true" >> $GITHUB_OUTPUT
            echo "skip_prescreen=false" >> $GITHUB_OUTPUT
          elif echo "$COMMENT_BODY" | grep -qF "@claude --full"; then
            # --full bypasses prescreen and forces complex review
            echo "tier=complex" >> $GITHUB_OUTPUT
            echo "override=true" >> $GITHUB_OUTPUT
            echo "skip_prescreen=true" >> $GITHUB_OUTPUT
          else
            echo "override=false" >> $GITHUB_OUTPUT
            echo "skip_prescreen=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract PR metadata
        id: extract
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          # Get list of changed files
          files=$(gh pr diff "$PR_NUMBER" --name-only | head -50)
          files_changed=$(echo "$files" | wc -l | tr -d ' ')
          echo "files_changed=$files_changed" >> $GITHUB_OUTPUT

          # Check for Lean files
          if echo "$files" | grep -qE '\.lean$'; then
            echo "has_lean_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_lean_files=false" >> $GITHUB_OUTPUT
          fi

          # Create a compact summary of changed files
          file_summary=$(echo "$files" | head -10 | tr '\n' ',' | sed 's/,$//')
          echo "summary=$file_summary" >> $GITHUB_OUTPUT

      - name: Run Claude Triage (if no override)
        if: steps.override.outputs.override == 'false'
        id: triage
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model haiku --max-turns 3"
          prompt: |
            You are the PR triage agent. Follow the instructions in .claude/prompts/triage.md exactly.

            After analysis, you MUST output a line in this exact format:
            TRIAGE_RESULT: <simple|moderate|complex>

            This line will be parsed to apply the correct label.

      - name: Parse triage result
        id: parse
        env:
          OVERRIDE: ${{ steps.override.outputs.override }}
          OVERRIDE_TIER: ${{ steps.override.outputs.tier }}
          TRIAGE_OUTPUT: ${{ steps.triage.outputs.response }}
        run: |
          if [[ "$OVERRIDE" == "true" ]]; then
            echo "tier=$OVERRIDE_TIER" >> $GITHUB_OUTPUT
          else
            # Parse the triage output for the result line
            if echo "$TRIAGE_OUTPUT" | grep -qF "TRIAGE_RESULT: simple"; then
              echo "tier=simple" >> $GITHUB_OUTPUT
            elif echo "$TRIAGE_OUTPUT" | grep -qF "TRIAGE_RESULT: moderate"; then
              echo "tier=moderate" >> $GITHUB_OUTPUT
            elif echo "$TRIAGE_OUTPUT" | grep -qF "TRIAGE_RESULT: complex"; then
              echo "tier=complex" >> $GITHUB_OUTPUT
            else
              # Default to moderate if parsing fails
              echo "tier=moderate" >> $GITHUB_OUTPUT
              echo "::warning::Could not parse triage result, defaulting to moderate"
            fi
          fi

      - name: Apply tier label
        uses: actions/github-script@v7
        with:
          script: |
            const tier = '${{ steps.parse.outputs.tier }}';
            const prNumber = ${{ github.event.issue.number || github.event.pull_request.number }};

            // Remove any existing claude tier labels
            const existingLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            for (const label of existingLabels.data) {
              if (label.name.startsWith('claude-')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label.name
                });
              }
            }

            // Add the new tier label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [`claude-${tier}`]
            });

            console.log(`Applied label: claude-${tier}`);

  # Call the appropriate tier workflow based on triage result
  call-simple:
    needs: triage
    if: needs.triage.outputs.tier == 'simple'
    uses: ./.github/workflows/claude-simple.yml
    with:
      pr_number: ${{ needs.triage.outputs.pr_number }}
      triage_summary: ${{ needs.triage.outputs.triage_summary }}
      files_changed: ${{ needs.triage.outputs.files_changed }}
    secrets: inherit

  call-moderate:
    needs: triage
    if: needs.triage.outputs.tier == 'moderate'
    uses: ./.github/workflows/claude-moderate.yml
    with:
      pr_number: ${{ needs.triage.outputs.pr_number }}
      triage_summary: ${{ needs.triage.outputs.triage_summary }}
      files_changed: ${{ needs.triage.outputs.files_changed }}
      has_lean_files: ${{ needs.triage.outputs.has_lean_files == 'true' }}
      skip_prescreen: ${{ needs.triage.outputs.skip_prescreen == 'true' }}
    secrets: inherit

  call-complex:
    needs: triage
    if: needs.triage.outputs.tier == 'complex'
    uses: ./.github/workflows/claude-complex.yml
    with:
      pr_number: ${{ needs.triage.outputs.pr_number }}
      triage_summary: ${{ needs.triage.outputs.triage_summary }}
      files_changed: ${{ needs.triage.outputs.files_changed }}
      has_lean_files: ${{ needs.triage.outputs.has_lean_files == 'true' }}
      skip_prescreen: ${{ needs.triage.outputs.skip_prescreen == 'true' }}
    secrets: inherit
