name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

# Workflow-level permissions inherited by all jobs and called workflows
permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  triage:
    # Skip draft PRs
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    outputs:
      tier: ${{ steps.parse.outputs.tier }}
      triage_summary: ${{ steps.extract.outputs.summary }}
      files_changed: ${{ steps.extract.outputs.files_changed }}
      additions: ${{ steps.extract.outputs.additions }}
      deletions: ${{ steps.extract.outputs.deletions }}
      has_lean_files: ${{ steps.extract.outputs.has_lean_files }}
      has_python_files: ${{ steps.extract.outputs.has_python_files }}
      has_binary_files: ${{ steps.extract.outputs.has_binary_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Extract PR metadata
        id: extract
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Get PR stats from GitHub API with timeout protection
          if ! timeout 30s gh pr view "$PR_NUMBER" --json additions,deletions,changedFiles,files > /tmp/pr_stats.json 2>&1; then
            echo "::error::Timeout or error fetching PR stats"
            echo "files_changed=0" >> $GITHUB_OUTPUT
            echo "additions=0" >> $GITHUB_OUTPUT
            echo "deletions=0" >> $GITHUB_OUTPUT
            echo "has_lean_files=false" >> $GITHUB_OUTPUT
            echo "has_python_files=false" >> $GITHUB_OUTPUT
            echo "has_binary_files=false" >> $GITHUB_OUTPUT
            echo "summary=" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi

          pr_stats=$(cat /tmp/pr_stats.json)
          additions=$(echo "$pr_stats" | jq -r '.additions')
          deletions=$(echo "$pr_stats" | jq -r '.deletions')
          files_changed=$(echo "$pr_stats" | jq -r '.changedFiles')
          files=$(echo "$pr_stats" | jq -r '.files[].path')

          echo "files_changed=$files_changed" >> $GITHUB_OUTPUT
          echo "additions=$additions" >> $GITHUB_OUTPUT
          echo "deletions=$deletions" >> $GITHUB_OUTPUT

          # Handle 0 files edge case
          if [ "$files_changed" -eq 0 ] 2>/dev/null || [ -z "$files" ]; then
            echo "::notice::PR has no file changes"
            echo "has_lean_files=false" >> $GITHUB_OUTPUT
            echo "has_python_files=false" >> $GITHUB_OUTPUT
            echo "has_binary_files=false" >> $GITHUB_OUTPUT
            echo "summary=" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Warn if large PR
          if [ "$files_changed" -gt 100 ]; then
            echo "::warning::Large PR with $files_changed files"
          fi

          # Check for Lean files
          if echo "$files" | grep -qE '\.lean$'; then
            echo "has_lean_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_lean_files=false" >> $GITHUB_OUTPUT
          fi

          # Check for Python files
          if echo "$files" | grep -qE '\.py$'; then
            echo "has_python_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_python_files=false" >> $GITHUB_OUTPUT
          fi

          # Check for binary files by extension
          if echo "$files" | grep -qE '\.(png|jpg|jpeg|gif|ico|pdf|zip|tar|gz|woff|woff2|ttf|eot|mp3|mp4|wav|avi|mov)$'; then
            echo "has_binary_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_binary_files=false" >> $GITHUB_OUTPUT
          fi

          # Create a compact summary of changed files
          file_summary=$(echo "$files" | head -10 | tr '\n' ',' | sed 's/,$//')
          echo "summary=$file_summary" >> $GITHUB_OUTPUT

          # Full file list for Claude
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Triage
        id: triage
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model haiku --max-turns 5"
          prompt: |
            You are the PR triage agent. Follow the instructions in .claude/prompts/triage.md exactly.

            IMPORTANT: Use ONLY the PR stats below. Do NOT run git commands - the checkout is shallow and will give wrong results.

            ## PR #${{ github.event.pull_request.number }} Stats (from GitHub API)
            - Files changed: ${{ steps.extract.outputs.files_changed }}
            - Lines added: ${{ steps.extract.outputs.additions }}
            - Lines removed: ${{ steps.extract.outputs.deletions }}
            - Has Lean files: ${{ steps.extract.outputs.has_lean_files }}
            - Changed files:
            ${{ steps.extract.outputs.files }}

            Based on ONLY these stats, output:
            TRIAGE_RESULT: <simple|moderate|complex>

      - name: Parse triage result
        id: parse
        env:
          EXECUTION_FILE: ${{ steps.triage.outputs.execution_file }}
        run: |
          # Validate execution file exists and is valid JSON
          if [ ! -f "$EXECUTION_FILE" ]; then
            echo "::error::Execution file not found: $EXECUTION_FILE"
            echo "tier=moderate" >> $GITHUB_OUTPUT
            echo "::warning::Defaulting to moderate tier due to missing execution file"
            exit 0
          fi

          if ! jq empty "$EXECUTION_FILE" 2>/dev/null; then
            echo "::error::Invalid JSON in execution file"
            # Note: Not dumping file contents to avoid potential secret leakage
            echo "tier=moderate" >> $GITHUB_OUTPUT
            echo "::warning::Defaulting to moderate tier due to invalid JSON"
            exit 0
          fi

          # Extract assistant messages from execution file (errors now visible)
          TRIAGE_OUTPUT=$(jq -r '.[] | select(.type == "assistant") | .message.content[]? | select(.type == "text") | .text' "$EXECUTION_FILE")
          # Note: Not logging TRIAGE_OUTPUT to avoid potential secret leakage

          # Parse the triage output for the result line
          if echo "$TRIAGE_OUTPUT" | grep -qF "TRIAGE_RESULT: simple"; then
            echo "tier=simple" >> $GITHUB_OUTPUT
            echo "::notice::Tier set to: simple"
          elif echo "$TRIAGE_OUTPUT" | grep -qF "TRIAGE_RESULT: moderate"; then
            echo "tier=moderate" >> $GITHUB_OUTPUT
            echo "::notice::Tier set to: moderate"
          elif echo "$TRIAGE_OUTPUT" | grep -qF "TRIAGE_RESULT: complex"; then
            echo "tier=complex" >> $GITHUB_OUTPUT
            echo "::notice::Tier set to: complex"
          else
            # Default to moderate if parsing fails
            echo "tier=moderate" >> $GITHUB_OUTPUT
            echo "::warning::Could not parse triage result, defaulting to moderate"
          fi

      - name: Apply tier label
        uses: actions/github-script@v7
        with:
          script: |
            const tier = '${{ steps.parse.outputs.tier }}';
            const prNumber = ${{ github.event.pull_request.number }};

            // Remove any existing claude tier labels
            const existingLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            for (const label of existingLabels.data) {
              if (label.name.startsWith('claude-')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label.name
                });
              }
            }

            // Add the new tier label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [`claude-${tier}`]
            });

            console.log(`Applied label: claude-${tier}`);

  # Call the appropriate tier workflow based on triage result
  call-simple:
    needs: triage
    if: needs.triage.outputs.tier == 'simple'
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    uses: ./.github/workflows/claude-simple.yml
    with:
      pr_number: "${{ github.event.pull_request.number }}"
      triage_summary: ${{ needs.triage.outputs.triage_summary }}
      files_changed: ${{ needs.triage.outputs.files_changed }}
    secrets: inherit

  call-moderate:
    needs: triage
    if: needs.triage.outputs.tier == 'moderate'
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    uses: ./.github/workflows/claude-moderate.yml
    with:
      pr_number: "${{ github.event.pull_request.number }}"
      triage_summary: ${{ needs.triage.outputs.triage_summary }}
      files_changed: ${{ needs.triage.outputs.files_changed }}
      has_lean_files: ${{ needs.triage.outputs.has_lean_files == 'true' }}
      skip_prescreen: false
    secrets: inherit

  call-complex:
    needs: triage
    if: needs.triage.outputs.tier == 'complex'
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    uses: ./.github/workflows/claude-complex.yml
    with:
      pr_number: "${{ github.event.pull_request.number }}"
      triage_summary: ${{ needs.triage.outputs.triage_summary }}
      files_changed: ${{ needs.triage.outputs.files_changed }}
      has_lean_files: ${{ needs.triage.outputs.has_lean_files == 'true' }}
      skip_prescreen: false
    secrets: inherit
